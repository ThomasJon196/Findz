<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>findz</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
            rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        #goBackButton {
            position: absolute;
            left: 2%;
            top: 2%;
            z-index: 999;
            border-radius: 5px;
            border: none;
            background: rgba(54, 88, 48, 0.85);
            color: white;
            padding: 8px 10px;;
        }

        #nearByList {
            position: absolute;
            left: 2%;
            bottom: 2%;
            z-index: 999;
            border-radius: 5px;
            background: rgba(54, 88, 48, 0.85);
            color: white;
            padding: 10px;
        }

        #openAddPointFormButton {
            background-color: #363636;
            color: white;
            padding: 10px 10px;
            border: none;
            border-radius: 5px;
            opacity: 0.8;
            position: fixed;
            top: 2%;
            right: 2%;
        }

        #openAddPointForm {
            display: none;
            position: fixed;
            bottom: 50%;
            left: 50%;
            top: 1%;
            right: 1%;
            z-index: 9;
        }

        #openPointForm {
            display: none;
            position: fixed;
            bottom: 50%;
            right: 50%;
            z-index: 9;
        }

        .form-container {
            max-width: 300px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
        }

        .form-container input[type=text] {
            width: 100%;
            padding: 15px;
            margin: 5px 0 22px 0;
            background-color: #F9F9F9;
            border-radius: 5px;
            border: 1px solid #DADADA;
        }

        /*.form-container input[type=text]:focus {
            background-color: #ddd;
            outline: none;
        }

         */


        .btn {
            background-color: #365830;
            color: white;
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            width: 40%;
            margin-bottom: 10px;
        }

        .closebtn {
            width: 100%;
            padding: 8px 10px;
        }

        .cancel {
            background-color: red;
        }


    </style>
    <!--<script>
        /*
        AFRAME.registerComponent('clicker', {
                init: function () {
                    console.log(this.el)
                    this.el.addEventListener('click', e => {
                        place = getPunkt(this.el.innerHTML);
                        console.log(" ergebniss getponkut" + place)
                        openPoint(place);
                    });
                },
            }
        );

        /*
        AFRAME.registerComponent('log', {
            schema: {type: 'string'},
            init: function () {
                var stringToLog = this.data;
                console.log(stringToLog);
            }
        });

         */
    </script>-->
</head>

<body>
<a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
         id="a-cene" cursor='rayOrigin: mouse' raycaster='near: 0; far: 50000'>
    <a-entity id="container">
        <!-- Hier wird das 3D-Objekt definiert -->
    </a-entity>
    <a-camera gps-camera rotation-reader far="100000"></a-camera>
</a-scene>


<button id="goBackButton" onclick="window.history.go(-1); return false;">
    zurück
</button>


<div id="nearByList">
    In deiner Nähe (<40m):
    <ul id="deviceList" style='list-style-type:square;'></ul>
</div>

<button id="openAddPointFormButton" onclick="openForm()">
    <span class="material-symbols-outlined">
        add_location_alt
    </span>
</button>

<div id="openPointForm">
    <div class="form-container">
        <h2 id="titlePoint"></h2>
        <p id="textPoint"></p>

        <button class="btn closebtn" onclick="closePoint()">Schließen</button>
    </div>
</div>

<div id="openAddPointForm">
    <div class="form-container">
        <h2>Markierung setzen</h2>

        <label for="titel"><b>Name</b></label>
        <input type="text" placeholder="Name" id="titel">

        <label for="beschreibung"><b>Beschreibung</b></label>
        <input type="text" placeholder="Beschreibung" id="beschreibung">

        <button class="btn" onclick="ongeopruefen()">Speichern</button>
        <button type="button" class="btn cancel" onclick="closeForm()">Verwerfen</button>
    </div>
</div>
</body>

<script>
    //katzen_bild = 'https://www.myself.de/Undefined/image-thumb__8934__header/katzenfotos_1.jpg'
    //thomas_bild = 'https://m.media-amazon.com/images/I/51PPdZidmBL._SX342_SY445_QL70_ML2_.jpg'
    //zuhause_bild = 'https://images.pexels.com/photos/7005018/pexels-photo-7005018.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'

    let punkteAr = []
    let zuNahListe = []
    let angezeigteFreunde = []
    //let testDataSet = false;

    var socket = io.connect('https://' + document.domain + ':' + location.port);

    const successCallback = (position) => {

        socket.emit('update', JSON.stringify({
            "name": '{{user}}',
            "latitude": position.coords.latitude,
            "longitude": position.coords.longitude,
            //  "bild": "images/Wiete.png"
        }))
        ownPosition = position
    };
    const errorCallback = (error) => {
        console.log(error);
    };

    let ownPosition;
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((coords) => {
            console.log("own position", coords)
            ownPosition = coords
        })
    } else {
        console.log("Geolocation is not supported by this browser.")
    }
    navigator.geolocation.watchPosition(successCallback, errorCallback)


    socket.emit('join', JSON.stringify({
        "name": '{{user}}',
        "current_group": '{{current_group}}'
    }))

    socket.on('redirect', function (destination) {
        window.location.href = destination;
    });


    function checkZunahFreund(freundNeu) {
        let entfernung = PythagorasEquirectangular(freundNeu.latitude, freundNeu.longitude, ownPosition.coords.latitude, ownPosition.coords.longitude)

        if ((entfernung < 0.04) && !zuNahListe.includes(freundNeu.name)) {
            zuNahListe.push(freundNeu.name)
            updateDeviceList();
            return true;
        } else if ((entfernung > 0.04) && zuNahListe.includes(freundNeu.name)) {
            for (let i = 0; i < zuNahListe.length; i++) {
                //  console.log(zuNahListe[i].localeCompare(andereUser.name)==0)
                if (zuNahListe[i].localeCompare(freundNeu.name + " ")) {
                    zuNahListe.splice(i, 1);
                    break;
                }
            }
            updateDeviceList();
            return false
        } else if (zuNahListe.includes(freundNeu.name)) {
            return true;
        }
        return false;
    }

    function erstelleFreundEntity(freundNeu) {

        let entfernung = PythagorasEquirectangular(freundNeu.latitude, freundNeu.longitude, ownPosition.coords.latitude, ownPosition.coords.longitude)
        var scale = 130

        //console.log("entfernung", entfernung)
        if (entfernung > 2.5) { // weiter als 2.5 -> groesse von 2.5
            scale *= (1 + (entfernung - 2.5))
        }

        if (entfernung < 0.5) { // naeher als 0.5 -> groesse von 0.5
            scale *= (0.6 - (0.5 - entfernung))
        }

        //console.log("element container",)
        //console.log("der selector", document.querySelector('#container'))
        //let element = document.querySelector('#container')
        let root = document.createElement("a-entity")
        //element.appendChild(root)
        //console.log("freundname erstelleFreundEntity", freundNeu.name)

        //root.setAttribute("id", freundNeu.name)
        //root.setAttribute("log", "wurzel erstellt")
        root.setAttribute("maxDistance", "5000000")
        root.setAttribute("look-at", "[gps-camera]")
        root.setAttribute("gps-entity-place", "latitude:" + freundNeu.latitude + "; longitude:" + freundNeu.longitude)


        let userText = document.createElement("a-text")
        if (entfernung > 1) {
            userText.setAttribute("value", entfernung + " km")
        } else {
            userText.setAttribute("value", (entfernung * 1000) + " m")
        }

        userText.setAttribute('position', 0 + " " + (-scale / 1.41) + " " + 0)
        userText.setAttribute("scale", scale + " " + scale + " " + scale)
        userText.setAttribute("align", "center")
        //   userText.setAttribute("maxDistance", "5000000")
        //   userText.setAttribute("look-at", "[gps-camera]")
        //   userText.setAttribute("gps-entity-place", "latitude:" + freundNeu.latitude + "; longitude:" + freundNeu.longitude)
        //console.log(userText)
        // var scene = document.querySelector('#a-cene')
        //scene.append(root)


        /*
                var pfeil = document.createElement("a-entity")
                pfeil.innerHTML = '<a-cone material="color: #FF4081; metalness: 0.2; roughness: 0.8" height="1" radius-bottom="0.4" radius-top="0.04" rotation="0 0 180"></a-cone> <a-cylinder color="#FF4081" height="3" radius="0.05" position="0 1.5 0"></a-cylinder>'
                pfeil.setAttribute("scale", (scale / 2) + " " + (scale / 2) + " " + (scale / 2))
                pfeil.setAttribute("position", 0 + " " + (scale * 2) + " " + 0)
        */

        var userBild = document.createElement("a-circle")

        userBild.setAttribute('align', 'center');
        //userBild.append('<a-image src=("src: " + freundNeu.bild)></a-image>')
        userBild.setAttribute("material", "src: " + freundNeu.bild)
        //userBild.setAttribute("material", "src= ww.png")
        userBild.setAttribute("scale", (scale / 1.6) + " " + (scale / 1.6) + " " + (scale / 1.6))
        //   userBild.setAttribute("maxDistance", "5000000")
        //   userBild.setAttribute("look-at", "[gps-camera]")
        //   userBild.setAttribute("gps-entity-place", "latitude:" + freundNeu.latitude + "; longitude:" + freundNeu.longitude)

        //var bild = document.createElement("a-image")
        //bild.setAttribute("src", "./ww.png")
        //bild.setAttribute("src", freundNeu.bild)
        //bild.setAttribute("radius", "1")
        //bild.setAttribute("theta-start", "0")

        //bild.setAttribute("theta-length", "360")


        root.appendChild(userBild)
        //root.append(bild)
        //   root.appendChild(pfeil)
        root.appendChild(userText)

        //element.appendChild(root)
        //console.log("freundname erstelleFreundEntity", userText)
        let element = document.querySelector('#container')
        element.appendChild(root)
    }

    function checkZunahPunkt(punkte) {
        let entfernung = PythagorasEquirectangular(punkte.latitude, punkte.longitude, ownPosition.coords.latitude, ownPosition.coords.longitude)

        if ((entfernung < 0.04) && !zuNahListe.includes(punkte.title)) {
            zuNahListe.push(punkte.title)
            updateDeviceList();
            return true
        } else if ((entfernung > 0.04) && zuNahListe.includes(punkte.title)) {
            for (let i = 0; i < zuNahListe.length; i++) {
                if (zuNahListe[i].localeCompare(punkte.title + " ")) {
                    zuNahListe.splice(i, 1);
                    break;
                }
            }
            updateDeviceList();
            return false
        } else if (zuNahListe.includes(punkte.title)) {
            return true
        }
        return false
    }

    function erstellePunktEntity(punkte) {
        let entfernung = PythagorasEquirectangular(punkte.latitude, punkte.longitude, ownPosition.coords.latitude, ownPosition.coords.longitude)
        var scale = 200


        let root = document.createElement("a-entity")

        root.setAttribute("id", punkte.title)
        root.setAttribute("maxDistance", "5000000")
        root.setAttribute("look-at", "[gps-camera]")
        root.setAttribute("gps-entity-place", "latitude:" + punkte.latitude + "; longitude:" + punkte.longitude)

        var userText = document.createElement("a-text")
        userText.setAttribute("id", punkte.title + "Text")
        if (entfernung > 1) {
            userText.setAttribute("value", punkte.title + " " + entfernung + " km")
        } else {
            userText.setAttribute("value", punkte.title + " " + (entfernung * 1000) + " m")
        }
        //   userText.setAttribute("maxDistance", "5000000")
        //   userText.setAttribute("look-at", "[gps-camera]")
        // userText.setAttribute("clicker", "")
        userText.setAttribute("align", "center")
        userText.innerText = punkte.title

        if (entfernung > 2.5) { // weiter als 2.5 -> groesse von 2.5
            scale *= (1 + (entfernung - 2.5))
        }
        if (entfernung < 0.5) { // naeher als 0.5 -> groesse von 0.5
            scale *= (0.6 - (0.5 - entfernung))
        }

        userText.setAttribute('position', 0 + " " + (scale*1.5) + " " + 0)
        //  userText.setAttribute("gps-entity-place", "latitude:" + punkte.latitude + "; longitude:" + punkte.longitude)
        userText.setAttribute("scale", (scale*1.3) + " " + (scale*1.3) + " " + (scale*1.3))


        var pfeil = document.createElement("a-entity")
        pfeil.setAttribute("id", punkte.title + "Pfeil")
        pfeil.innerHTML = '<a-cone position="0 0 0" rotation="-180 0 0" height="1.2" radius-bottom="1.2" color="#FF0000"></a-cone> <a-sphere position="0 1.68 0" radius="1.6" color="#FF0000" rotation="180 0 0"></a-sphere>'
        pfeil.setAttribute("scale", (scale / 2.5) + " " + (scale / 2.5) + " " + (scale / 2.5))
        pfeil.setAttribute("position", 0 + " " + (scale * 2) + " " + 0)


        let element = document.querySelector('a-scene')
        //element.appendChild(userText)

        pfeil.addEventListener('click', function (e) {
            openPoint(punkte, e);
        })

        root.appendChild(pfeil)
        root.appendChild(userText)
        //console.log("entität",root)
        element.appendChild(root)
    }

    function updatePunkt(punktNeu) {
        let entfernung = PythagorasEquirectangular(punktNeu.latitude, punktNeu.longitude, ownPosition.coords.latitude, ownPosition.coords.longitude)
        var scale = 200

        let root = document.getElementById(punktNeu.title)

        root.setAttribute("gps-entity-place", "latitude:" + punktNeu.latitude + "; longitude:" + punktNeu.longitude)

        var userText = document.getElementById(punktNeu.title + "Text")

        if (entfernung > 1) {
            userText.setAttribute("value", punktNeu.title + " " + entfernung  + " km")
        } else {
            userText.setAttribute("value", punktNeu.title + " " + (entfernung * 1000) + " m")
        }

        userText.innerText = punktNeu.title

        if (entfernung > 2.5) { // weiter als 2.5 -> groesse von 2.5
            scale *= (1 + (entfernung - 2.5))
        }
        if (entfernung < 0.5) { // naeher als 0.5 -> groesse von 0.5
            scale *= (0.6 - (0.5 - entfernung))
        }

        userText.setAttribute('position', 0 + " " + (scale*1.5) + " " + 0)
        //  userText.setAttribute("gps-entity-place", "latitude:" + punkte.latitude + "; longitude:" + punkte.longitude)
        userText.setAttribute("scale", (scale*1.3) + " " + (scale*1.3) + " " + (scale*1.3))


        var pfeil = document.getElementById(punktNeu.title + "Pfeil")
        pfeil.setAttribute("scale", (scale / 2.5) + " " + (scale / 2.5) + " " + (scale / 2.5))
        pfeil.setAttribute("position", 0 + " " + (scale * 2) + " " + 0)

    }

    socket.on('answer', function (msg) {
        let freundeListeNeu = JSON.parse(msg)[0].filter(element => element['name'] !== '{{user}}');
        let punkteListeNeu = JSON.parse(msg)[1];

        /*
        punkteListeNeu.forEach(p =>{
            let element = document.getElementById(p.title)
            if (element !==null) {
                console.log(element)
              //  element.removeEventListener('click', openPoint)
            }
        })
         */

        document.querySelector('#container').innerHTML = '';

        freundeListeNeu.forEach(freundNeu => {
            if (typeof freundNeu.name != "undefined") {
                let checkZunahFreundErg = checkZunahFreund(freundNeu);
                if (!checkZunahFreundErg) {
                    erstelleFreundEntity(freundNeu)
                }

            }
        });
        /*
        angezeigteFreunde.forEach(freundAktuell => {
            if (typeof (freundAktuell) != "undefined") {
                removeOfflineUser(freundAktuell, freundeListeNeu)
            }
        });
         */

        punkteListeNeu.forEach(punktNeu => {
            /*
            let checkZunahPunktErg = checkZunahPunkt(punktNeu);
            if (!checkZunahPunktErg){
                erstellePunktEntity(punktNeu)
            }
            */

            for (let i = 0; i < punkteAr.length; i++) {
                if (0 === punkteAr[i].title.localeCompare(punktNeu.title)) {
                    updatePunkt(punktNeu)
                    //console.log("punkt geupdated: ", punktNeu)
                    return
                }
            }
            punkteAr.push(punktNeu)
            console.log("punkt erstellt:  ", punktNeu)
            erstellePunktEntity(punktNeu)
        });
    });


    function updateDeviceList() {
        // Leere die Liste
        var deviceList = document.querySelector('#deviceList')
        deviceList.innerHTML = ""
        // Füge jedes Gerät als Listenelement hinzu
        for (index in zuNahListe) {
            const deviceItem = document.createElement('li');
            deviceItem.innerText = zuNahListe[index];
            deviceList.appendChild(deviceItem);
        }
    }

    function openPoint(punkt, e) {
        //console.log(e);
        e.stopPropagation();
        //e.preventDefault();
        console.log("punkt : " + punkt["title"])

        document.getElementById("titlePoint").innerHTML = punkt["title"]
        document.getElementById("textPoint").innerHTML = punkt["text"]

        document.getElementById("openPointForm").style.display = "block";

    }

    function closePoint() {
        document.getElementById("openPointForm").style.display = "none";
        //document.getElementById("titlePoint").innerHTML = ""
        //document.getElementById("textPoint").innerHTML = ""
    }

    function openForm() {
        document.getElementById("openAddPointForm").style.display = "block";
    }

    function closeForm() {
        document.getElementById("titel").value = "";
        document.getElementById("beschreibung").value = "";
        document.getElementById("openAddPointForm").style.display = "none";
    }

    function ongeopruefen() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(markierungSetzten);
        } else {
            console.log("Geolocation is not supported by this browser.")
        }
    }

    function makierungSetzten(loc) {


        let title = document.getElementById("titel").value;
        let beschreibung = document.getElementById("beschreibung").value;

        /*if(titel.localeCompare(" ") || titel == null){
            closeForm()
            return
        }*/

        fetch("https://" + document.domain + ":" + location.port + "/save_point", {
            method: "POST",
            body: JSON.stringify({
                "title": title,
                "text": beschreibung,
                "latitude": loc.coords.latitude,
                "longitude": loc.coords.longitude
            })
            ,
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        }).then(response => response.json())
            .then(data => {
                console.log("Response received:", data);
            })
            .catch(error => {
                console.error("Error occurred:", error);
            });

        console.log("added new point" + title);
        closeForm();


        /*
                  //socket.emit('update', JSON.stringify({ "name": titel, "latitude": lokation.coords.latitude , "longitude": lokation.coords.longitude, "bild": "images/Wiete.png" }))

         */
    }


    function Deg2Rad(deg) {
        return deg * Math.PI / 180;
    }

    function PythagorasEquirectangular(lat1, lon1, lat2, lon2) {
        lat1 = Deg2Rad(lat1);
        lat2 = Deg2Rad(lat2);
        lon1 = Deg2Rad(lon1);
        lon2 = Deg2Rad(lon2);
        var R = 6371; // km
        var x = (lon2 - lon1) * Math.cos((lat1 + lat2) / 2);
        var y = (lat2 - lat1);
        var d = Math.sqrt(x * x + y * y) * R;
        return d.toFixed(2);
    }




    /*
        function getPunkt(punkt) {
            var ergebnis;
            punkteAr.forEach(element => {
                console.log("das sind die punkte" + element["title"])
            });
            console.log("bin der vergleichspunkt" + punkt)
            punkteAr.forEach(element => {
                if (0 === element["title"].localeCompare(punkt)) {
                    console.log(" fuck this" + element["title"])
                    ergebnis = element;
                }
            });
            return ergebnis;
        }

        function checkClose(position) {
            return (0.00001 < Math.abs(ownPosition.coords.latitude - position.coords.latitude) + Math.abs(ownPosition.coords.longitude - position.coords.longitude))
        }

        function updateFriend(freundNeu) {
            let element = document.getElementById(freundNeu.name)
            element.setAttribute("gps-entity-place", "latitude:" + freundNeu.latitude + "; longitude:" + freundNeu.longitude)
        }

        function updateFreundesListe(freundNeu) {

            if (checkZunahFreund(freundNeu)) {
                return
            }

            //console.log("freunde aktuell")

            for (let i = 0; i <= angezeigteFreunde.length; i++) {
                console.log("freunde aktuell", angezeigteFreunde[i].name)
                console.log("freunde neu", freundNeu.name)
                console.log(0 === angezeigteFreunde[i].name.localeCompare(freundNeu.name))
                if (0 === angezeigteFreunde[i].name.localeCompare(freundNeu.name)) {
                    //           console.log("updatefriendList" + freundNeu.name)
                    //updateFriend(freundNeu);
                    return
                }
            }
            console.log("hier nicht")
            angezeigteFreunde.push(freundNeu)
            erstelleFreundEntity(freundNeu)
        }

        function updatePunkteListe(punktNeu) {

            if (checkZunahPunkt(punktNeu)) {
                return
            }

            for (let i = 0; i < punkteAr.length; i++) {
                if (0 === punkteAr[i].title.localeCompare(punktNeu.title)) {
                    return
                }
            }
            punkteAr.push(punktNeu)
            erstellePunktEntity(punktNeu)

        }

        function removeOfflineUser(freundAktuell, freundlisteNeu) {
            freundlisteNeu.forEach(freundneu => {
                if (0 === freundneu.name.localeCompare(freundAktuell.name)) {
                    return
                }
            })
            angezeigteFreunde.splice(angezeigteFreunde.indexOf(freundAktuell), 1);
            let element = document.getElementById(freundAktuell.name);
            let root = document.getElementById("container");
            root.remove(element);
        }

        function addTestData() {

            let testFreund1 = {
                "name": "RingKiosk",
                "latitude": "50.79846715949979",
                "longitude": "7.2058313596181565",
                "bild": zuhause_bild
            };

            let testFreund2 = {
                "name": "Koeln",
                "latitude": 50.726878,
                "longitude": 7.084104,
                "bild": thomas_bild
            }
            let testPunkt1 = {
                "title": 'hbrs',
                "text": 'wir lieben es alle ',
                "latitude": 50.78001445359288,
                "longitude": 7.182461982104352
            }
            if (testDataSet) {

            } else {
                erstelleFreundEntity(testFreund1)
                //erstelleFreundEntity(testFreund2)
            }
            checkZunahFreund(testFreund1)
            //checkZunahFreund(testFreund2)

            //updatePunkteListe(testPunkt1)
            testDataSet = true
        }
    */
</script>

</html>
