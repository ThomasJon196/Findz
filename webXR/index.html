<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        /* Button used to open the contact form - fixed at the bottom of the page */
        .open-button {
            background-color: #555;
            color: white;
            padding: 8px 10px;
            border: none;
            cursor: pointer;
            opacity: 0.8;
            position: fixed;
            bottom: 23px;
            right: 28px;
            width: 100px;
        }

        /* The popup form - hidden by default */
        .form-popup {
            display: none;
            position: fixed;
            bottom: 50%;
            right: 50%;
            border: 3px solid #f1f1f1;
            z-index: 9;
        }

        /* Add styles to the form container */
        .form-container {
            max-width: 300px;
            padding: 10px;
            background-color: white;
        }

        /* Full-width input fields */
        .form-container input[type=text], .form-container input[type=password] {
            width: 100%;
            padding: 15px;
            margin: 5px 0 22px 0;
            border: none;
            background: #f1f1f1;
        }

        /* When the inputs get focus, do something */
        .form-container input[type=text]:focus, .form-container input[type=password]:focus {
            background-color: #ddd;
            outline: none;
        }

        /* Set a style for the submit/login button */
        .form-container .btn {
            background-color: #04AA6D;
            color: white;
            padding: 16px 20px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        /* Add a red background color to the cancel button */
        .form-container .cancel {
            background-color: red;
        }

        /* Add some hover effects to buttons */
        .form-container .btn:hover, .open-button:hover {
            opacity: 1;
        }
    </style>
    <script>
        AFRAME.registerComponent('clicker', {
                init: function () {
                    console.log(this.el)
                    this.el.addEventListener('click', e => {
                        place = getPunkt(this.el.innerHTML);
                        console.log(" ergebniss getponkut" + place)
                        openPoint(place);
                    });
                }
                ,
                remove: function () {
                    console.log(this.el)
                    this.el.removeEventListener('click', e => {
                        place = getPunkt(this.el.innerHTML);
                        console.log(" ergebniss getponkut" + place)
                        openPoint(place);
                    });
                },
            }
        );
    </script>
</head>

<body>
<a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
         id="a-cene" cursor='rayOrigin: mouse' raycaster='near: 0; far: 50000'>
    <a-entity id="container">
        <!-- Hier wird das 3D-Objekt definiert -->
    </a-entity>
    <!-- ></a-entity>-->
    <a-camera gps-camera rotation-reader far="100000"></a-camera>

</a-scene>

<div>
    <button onclick="location.href='https://findz.thomasjonas.de/gruppen'"
            style='position:absolute; left: 2%; top: 2%; z-index:999; border-radius:5px; background: rgba(54,88,48,0.85); color: white; padding: 5px'>
        zurück
    </button>
</div>

<div id='setloc'
     style='position:absolute; left: 5px; bottom: 2%; z-index:999; border-radius:5px; background: rgba(54,88,48,0.85); color: white; padding: 10px'>
    In deiner Nähe (<30m):
    <ul id="deviceList" style='list-style-type:square;'></ul>
</div>

<div id='2'
     style='position:absolute; right: 2%; bottom: 2%; z-index:999; border-radius:5px; background: rgba(54,88,48,0.85); color: white; padding: 5px'>
    <button class="open-button" onclick="openForm()">Makierung setzten</button>
</div>


<div class="form-popup" id="myPoint">
    <div class="form-container" id="1">
        <h1>Makierung</h1>
        <h2 id="titelp"></h2>

        <a id="textp"></a>

        <button class="btn" onclick="closePoint()">Schließen</button>

    </div>
</div>

<div class="form-popup" id="myForm">
    <div class="form-container" id="0">
        <h1>Makierung</h1>

        <label for="titel"><b>Name</b></label>
        <input type="text" placeholder="titel" id="titel" required>

        <label for="beschreibung"><b>Beschreibung</b></label>
        <input type="text" placeholder="beschreibung" id="beschreibung" required>

        <button class="btn" onclick="ongeopruefen()">Speichern</button>
        <button type="button" class="btn cancel" onclick="closeForm()">Verwerfen</button>
    </div>
</div>
</body>

<script>
    katzen_bild = 'https://www.myself.de/Undefined/image-thumb__8934__header/katzenfotos_1.jpg'
    thomas_bild = 'https://m.media-amazon.com/images/I/51PPdZidmBL._SX342_SY445_QL70_ML2_.jpg'
    zuhause_bild = 'https://images.pexels.com/photos/7005018/pexels-photo-7005018.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'

    let punkteAr = []
    let zuNahListe = []

    const successCallback = (position) => {
        // console.log(position);
        // console.log('{{user}}')
        if (typeof ownPosition !== 'undefined') {
            if (checkClose(position)) {
                return
            }
        }
        socket.emit('update', JSON.stringify({
            "name": '{{user}}',
            "latitude": position.coords.latitude,
            "longitude": position.coords.longitude,
            "bild": "images/Wiete.png"
        }))
        ownPosition = position
    };
    const errorCallback = (error) => {
        console.log(error);
    };

    let ownPosition;
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((coords) => {
            ownPosition = coords
        })
    } else {
        console.log("Geolocation is not supported by this browser.")
    }
    navigator.geolocation.watchPosition(successCallback, errorCallback)


    


    var socket = io.connect('https://' + document.domain + ':' + location.port);

    socket.emit('join', JSON.stringify({
        "name": '{{user}}',
        "current_group": '{{current_group}}'
    }))

    socket.on('redirect', function (destination) {
        window.location.href = destination;
    });

    socket.on('answer', function (msg) {
        clearScene()

        JSON.parse(msg)[0].forEach(element => {
            if (element['name'] != '{{user}}') {
                //console.log(" Empfangene name" + element['name'])
                zeigeUseran2(element, ownPosition.coords)
            }
        });
        zeigeUseran2({
            "name": "RingKiosk",
            "latitude": "50.79846715949979",
            "longitude": "7.2058313596181565",
            "bild": zuhause_bild
        }, ownPosition.coords);
        zeigeUseran2({
            "name": "Koeln",
            "latitude": 50.932779,
            "longitude": 6.958231,
            "bild": thomas_bild
        }, ownPosition.coords);
        // zeigeUseran({ "name": "hbrs", "latitude": "50.78001445359288", "longitude": "7.182461982104352", "bild": thomas_bild }, ownPosition.coords);
        // zeigeUseran({ "name": "shitfest", "latitude": "34.668730658268004", "longitude": "135.4295393926713", "bild": zuhause_bild}, ownPosition.coords);
        // zeigeUseran({ "name": "zuhause", "latitude": "50.799501761695296", "longitude": "7.205012353349729", "bild": zuhause_bild}, ownPosition.coords);

        punkteAr = JSON.parse(msg)[1]
        console.log(typeof punkteAr)
        // console.log("ich bin die angekommene nachicht" + punkteAr)
        JSON.parse(msg)[1].forEach(makierterPunkt => zeigePunkteAn(makierterPunkt, ownPosition.coords));
        punkteAr.push({
            "title": 'hbrs',
            "text": 'wir lieben es alle ',
            "latitude": 50.78001445359288,
            "longitude": 7.182461982104352
        })
        zeigePunkteAn({
            "title": 'hbrs',
            "text": 'wir lieben es alle ',
            "latitude": 50.78001445359288,
            "longitude": 7.182461982104352
        }, ownPosition.coords)

    });


    function openPoint(punkt) {
        //    console.log("punkt : " + punkt)
        document.getElementById("titelp").innerHTML = punkt["title"]
        document.getElementById("textp").innerHTML = punkt["text"]

        document.getElementById("myPoint").style.display = "block";
    }

    function getPunkt(punkt) {
        var ergebnis;
        punkteAr.forEach(element => {
            console.log("das sind die punkte" + element["title"])
        });
        console.log("bin der vergleichspunkt" + punkt)
        punkteAr.forEach(element => {
            if (0 === element["title"].localeCompare(punkt)) {
                console.log(" fuck this" + element["title"])
                ergebnis = element;
            }
        });
        return ergebnis;
    }

    function closePoint() {
        document.getElementById("myPoint").style.display = "none";
        //document.getElementById("titelp").innerHTML = ""
        //document.getElementById("textp").innerHTML = ""
    }

    function openForm() {
        document.getElementById("myForm").style.display = "block";
    }

    function closeForm() {
        document.getElementById("titel").value = "";
        document.getElementById("beschreibung").value = "";
        document.getElementById("myForm").style.display = "none";
    }

    function ongeopruefen() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(makierungSetzten);
        } else {
            console.log("Geolocation is not supported by this browser.")
        }

    }

    function makierungSetzten(location) {

        let titel = document.getElementById("titel").value;
        let beschreibung = document.getElementById("beschreibung").value;

        //console.log("imhereto die" + titel)
        /*if(titel.localeCompare(" ") || titel == null){
            closeForm()
            return
        }*/

        fetch("https://findz.thomasjonas.de/save_point", {
            method: "POST",
            body: JSON.stringify({
                "title": titel,
                "text": beschreibung,
                "latitude": location.coords.longitude,
                "longitude": location.coords.latitude
            })
            ,
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        }).then(response => response.json())
            .then(data => {
                console.log("Response received:", data);
            })
            .catch(error => {
                console.error("Error occurred:", error);
            });

        console.log("imhereto die" + titel)
        JSON.stringify({
            "titel": titel,
            "beschreibung": beschreibung,
            "latitude": location.coords.latitude,
            "longitude": location.coords.longitude
        })

        closeForm()

        /*
                  console.log(JSON.stringify({ "name": titel, "latitude": lokation.coords.latitude , "longitude": lokation.coords.longitude, "bild": "images/Wiete.png" }))
                  //socket.emit('update', JSON.stringify({ "name": titel, "latitude": lokation.coords.latitude , "longitude": lokation.coords.longitude, "bild": "images/Wiete.png" }))

                  closeForm();
         */
    }

    function clearScene() {
        document.querySelector('#container').innerHTML = '';
    }

    function Deg2Rad(deg) {
        return deg * Math.PI / 180;
    }

    function PythagorasEquirectangular(lat1, lon1, lat2, lon2) {

        lat1 = Deg2Rad(lat1);
        lat2 = Deg2Rad(lat2);
        lon1 = Deg2Rad(lon1);
        lon2 = Deg2Rad(lon2);
        var R = 6371; // km
        var x = (lon2 - lon1) * Math.cos((lat1 + lat2) / 2);
        var y = (lat2 - lat1);
        var d = Math.sqrt(x * x + y * y) * R;
        return d.toFixed(2);
    }

    function updateDeviceList() {
        // Leere die Liste
        var deviceList = document.querySelector('#deviceList')
        deviceList.innerHTML = ""
        // Füge jedes Gerät als Listenelement hinzu
        for (index in zuNahListe) {
            //     console.log(zuNahListe[index])
            const deviceItem = document.createElement('li');
            deviceItem.innerText = zuNahListe[index]
            deviceList.appendChild(deviceItem);
        }
    }

    function zeigeUseran2(andereUser, coordinaten) {

        // console.log(andereUser)
        let entfernung = PythagorasEquirectangular(andereUser.latitude, andereUser.longitude, coordinaten.latitude, coordinaten.longitude)
        //  console.log('ich bin die entfernung:'+ entfernung)


        if ((entfernung < 0.04) && !zuNahListe.includes(andereUser.name)) {
            zuNahListe.push(andereUser.name)
            updateDeviceList();
            return
        } else if ((entfernung > 0.04) && zuNahListe.includes(andereUser.name)) {
            for (let i = 0; i < zuNahListe.length; i++) {
                //  console.log(zuNahListe[i].localeCompare(andereUser.name)==0)
                if (zuNahListe[i].localeCompare(andereUser.name + " ")) {
                    zuNahListe.splice(i, 1);
                    //   console.log('ich bin bei zu nah und schon da')
                    break;
                }
            }
            updateDeviceList();

        } else if (zuNahListe.includes(andereUser.name)) {
            return
        }


        var scale = 130
        if (entfernung > 2.5) { // weiter als 2.5 -> groesse von 2.5
            scale *= (1 + (entfernung - 2.5))
        }

        if (entfernung < 0.5) { // naeher als 0.5 -> groesse von 0.5
            scale *= (1 - (0.5 - entfernung))
        }


        root = document.createElement("a-entity")
        root.setAttribute("maxDistance", "5000000")
        root.setAttribute("look-at", "[gps-camera]")
        root.setAttribute("gps-entity-place", "latitude:" + andereUser.latitude + "; longitude:" + andereUser.longitude)

        var userText = document.createElement("a-text")
        if (entfernung > 1) {
            userText.setAttribute("value", entfernung + " km")
        } else {
            userText.setAttribute("value", (entfernung * 1000) + " m")
        }

        userText.setAttribute('position', 0 + " " + (-scale / 1.5) + " " + 0)
        userText.setAttribute("scale", scale + " " + scale + " " + scale)
        userText.setAttribute("align", "center")


        var pfeil = document.createElement("a-entity")
        pfeil.innerHTML = '<a-cone material="color: #FF4081; metalness: 0.2; roughness: 0.8" height="1" radius-bottom="0.4" radius-top="0.04" rotation="0 0 180"></a-cone> <a-cylinder color="#FF4081" height="3" radius="0.05" position="0 1.5 0"></a-cylinder>'
        pfeil.setAttribute("scale", (scale / 2) + " " + (scale / 2) + " " + (scale / 2))
        pfeil.setAttribute("position", 0 + " " + (scale * 2) + " " + 0)


        element = document.querySelector('#container')
        element2 = document.querySelector('#a-cene')


        var userBild = document.createElement("a-circle")

        userBild.setAttribute('align', 'center');
        //userBild.setAttribute('rotation', "-90 0 0");
        userBild.setAttribute("material", "src: " + andereUser.bild)
        userBild.setAttribute("scale", (scale / 1.6) + " " + (scale / 1.6) + " " + (scale / 1.6))
        //userBild.setAttribute("gps-entity-place", "latitude:" + andereUser.latitude + "; longitude:" + andereUser.longitude)
        //userBild.setAttribute("clicker", "")


        /*
                userBild.setAttribute('align', 'center');
                userBild.setAttribute("src", andereUser.bild)
                userBild.setAttribute("scale", scale + " " + scale + " " + scale)
                   userBild.setAttribute("gps-entity-place", "latitude:" + andereUser.latitude + "; longitude:" + andereUser.longitude)
                userBild.setAttribute("clicker", "")
        */

        element = document.querySelector('#container')

        root.appendChild(userBild)
        root.appendChild(pfeil)
        root.appendChild(userText)
        element.appendChild(root)
    }

    function zeigePunkteAn(punkte, coordinaten) {
        //console.log("ich bin der punkt in zeige punkt an" + punkte)

        let entfernung = PythagorasEquirectangular(punkte.latitude, punkte.longitude, coordinaten.latitude, coordinaten.longitude)
        //  console.log('ich bin die entfernung:'+ entfernung)
        //  console.log("title" +  punkte.title)
        //  console.log("entfernung" + entfernung)

        if ((entfernung < 0.04) && !zuNahListe.includes(punkte.title)) {
            //  console.log(punkte.title)
            zuNahListe.push(punkte.title)
            updateDeviceList();

            return
        } else if ((entfernung > 0.04) && zuNahListe.includes(punkte.title)) {

            for (let i = 0; i < zuNahListe.length; i++) {
                //  console.log(zuNahListe[i].localeCompare(andereUser.name)==0)
                if (zuNahListe[i].localeCompare(punkte.title + " ")) {
                    zuNahListe.splice(i, 1);
                    //   console.log('ich bin bei zu nah und schon da')
                    break;
                }
            }
            updateDeviceList();

        } else if (zuNahListe.includes(punkte.title)) {
            return
        }

        var scale = 200

        var userText = document.createElement("a-text")
        if (entfernung > 1) {
            userText.setAttribute("value", punkte.title + " " + entfernung + " km")
        } else {
            userText.setAttribute("value", punkte.title + " " + entfernung + " m")
        }
        userText.setAttribute("maxDistance", "5000000")
        userText.setAttribute("look-at", "[gps-camera]")
        userText.setAttribute("clicker", "")
        userText.innerText = punkte.title

        if (entfernung > 2.5) { // weiter als 2.5 -> groesse von 2.5
            scale *= (1 + (entfernung - 2.5))
        }
        if (entfernung < 0.5) { // naeher als 0.5 -> groesse von 0.5
            scale *= (1 - (0.5 - entfernung))
        }

        userText.setAttribute('position', 0 + " " + (scale) + " " + 0)
        userText.setAttribute("gps-entity-place", "latitude:" + punkte.latitude + "; longitude:" + punkte.longitude)
        userText.setAttribute("scale", scale + " " + scale + " " + scale)

        //console.log(userText)
        //console.log(" hier sollte user text sein" + userText)
        element = document.querySelector('#container')
        element.appendChild(userText)
    }

    function checkClose(position) {
        return (0.00001 < Math.abs(ownPosition.coords.latitude - position.coords.latitude) + Math.abs(ownPosition.coords.longitude - position.coords.longitude))
    }

</script>

</html>

<!--

/* function zeigeUseran(andereUser, coordinaten) {

        // console.log(andereUser)
         let entfernung = PythagorasEquirectangular(andereUser.latitude, andereUser.longitude, coordinaten.latitude, coordinaten.longitude)
         //  console.log('ich bin die entfernung:'+ entfernung)


         if ((entfernung < 0.04) && !zuNahListe.includes(andereUser.name)) {
             zuNahListe.push(andereUser.name)
             updateDeviceList();
             return
         } else if ((entfernung > 0.04) && zuNahListe.includes(andereUser.name)) {
             for (let i = 0; i < zuNahListe.length; i++) {
                 //  console.log(zuNahListe[i].localeCompare(andereUser.name)==0)
                 if (zuNahListe[i].localeCompare(andereUser.name + " ")) {
                     zuNahListe.splice(i, 1);
                     //   console.log('ich bin bei zu nah und schon da')
                     break;
                 }
             }
             updateDeviceList();

         } else if (zuNahListe.includes(andereUser.name)) {
             return
         }




         var scale = 200
         if (entfernung > 2.5) { // weiter als 2.5 -> groesse von 2.5
             scale *= (1 + (entfernung - 2.5))

         }
         if (entfernung < 0.5) { // naeher als 0.5 -> groesse von 0.5
             scale *= (1 - (0.5 - entfernung))

         }

         var userText = document.createElement("a-text")
         if (entfernung > 1) {
             userText.setAttribute("value", entfernung + " km")
         } else {
             userText.setAttribute("value", (entfernung*1000) + " m")
         }
         userText.setAttribute("maxDistance", "5000000")
         userText.setAttribute("look-at", "[gps-camera]")
         userText.setAttribute('position', 0 + " " + (scale) + " " + 0)
         userText.setAttribute("gps-entity-place", "latitude:" + andereUser.latitude + "; longitude:" + andereUser.longitude)

         var sign = document.createElement("a-entity")
         //sign.setAttribute("text", "value", "HELLO", "height" , "10")
         sign.setAttribute("text", "width: 4; value: This text will be 4 units wide.")
         sign.setAttribute("id", "refresh-button")
         sign.setAttribute("look-at", "[gps-camera]")
         sign.setAttribute("geometry", "primitive: plane; radius: auto")
         sign.setAttribute("maxDistance", "5000000")
         sign.setAttribute("material", "color: #dfecec")
         sign.setAttribute("gps-entity-place", "latitude:" + andereUser.latitude + "; longitude:" + andereUser.longitude)
         sign.setAttribute("scale", scale + " " + scale + " " + scale)


         var pfeil = document.createElement("a-entity")
         pfeil.setAttribute("gps-entity-place", "latitude:" + andereUser.latitude + "; longitude:" + andereUser.longitude)
         pfeil.innerHTML = '<a-cone material="color: #FF4081; metalness: 0.2; roughness: 0.8" height="1" radius-bottom="0.4" radius-top="0.04" rotation="0 0 180"></a-cone> <a-cylinder color="#FF4081" height="3" radius="0.05" position="0 1.5 0"></a-cylinder>'

         pfeil.setAttribute("scale", scale + " " + scale + " " + scale)
         pfeil.setAttribute("position", scale + " " + scale + " " + scale)

         element = document.querySelector('#container')
        // beschriftung = document.createElement("iframe")

         element2 = document.querySelector('#a-cene')
         //beschriftung.innerHTML ='<button style="background-color: #4CAF50;  border: none; color: white; padding: 10px 20px;text-align: center;text-decoration: none;display: inline-block;font-size: 16px;margin: 4px 2px;cursor: pointer;border-radius: 5px;"> fuck </button>'
         //var userText = document.createElement("a-text")
         element2.appendChild(sign)
         //element.appendChild(pfeil)
         console.log(sign)
         //userText.setAttribute("scale", scale + " " + scale + " " + scale)
         //userText.setAttribute('align', 'center');



         var userBild = document.createElement("a-image")

         userBild.setAttribute('align', 'center');
         userBild.setAttribute("src", andereUser.bild)
         userBild.setAttribute("maxDistance", "5000000")
         userBild.setAttribute("look-at", "[gps-camera]")
         userBild.setAttribute("scale", scale + " " + scale + " " + scale)
         userBild.setAttribute("gps-entity-place", "latitude:" + andereUser.latitude + "; longitude:" + andereUser.longitude)
         userBild.setAttribute("clicker", "")

         element = document.querySelector('#container')

         element.appendChild(userBild)
         element.appendChild(userText)

     }
 */

-->

<!--  <script> AFRAME.registerComponent('scale-based-on-distance', {
    schema: {
      minDistance: {type: 'number', default: 1},
      maxDistance: {type: 'number', default: 10},
      minScale: {type: 'number', default: 0.1},
      maxScale: {type: 'number', default: 1}
    },

    init: function () {
      this.camera = document.querySelector('#camera');
      this.object = this.el;
    },

    tick: function () {
      var distance = this.camera.object3D.position.distanceTo(this.object.object3D.position);
      var scale = this.scaleForDistance(distance, this.data.minDistance, this.data.maxDistance, this.data.minScale, this.data.maxScale);
      this.object.setAttribute('scale', {x: scale, y: scale, z: scale});
    },

    scaleForDistance: function (distance, minDistance, maxDistance, minScale, maxScale) {
      if (distance < minDistance) {
        return maxScale;
      } else if (distance > maxDistance) {
        return minScale;
      } else {
        return (maxScale - minScale) * (1 - (distance - minDistance) / (maxDistance - minDistance)) + minScale;
      }
    }

  });</script> -->
